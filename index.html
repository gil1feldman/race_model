<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>בודק מהימנות לידיעה - שיטת RACE</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      padding: 20px;
      background: linear-gradient(to bottom, #e9f0f7, #fefefe);
      color: #222;
      line-height: 1.6;
      max-width: 850px;
      margin: auto;
    }

    h1 {
      color: #003366;
      font-size: 28px;
      margin-bottom: 20px;
      text-align: center;
      background-color: #d0e4f7;
      padding: 10px;
      border-radius: 10px;
    }

    #toggleBtn {
      background-color: transparent;
      color: #005fa3;
      border: none;
      font-size: 13px;
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
      margin: 5px 0;
    }

    #toggleBtn.open::before {
      content: '-';
      margin-left: 5px;
    }

    #toggleBtn::before {
      content: '+';
      margin-left: 5px;
    }

    #explanation {
      background: #f9f9f9;
      border-right: 3px solid #aac8df;
      padding: 10px 14px;
      margin: 10px 0 20px;
      border-radius: 6px;
      font-size: 15px;
      line-height: 1.5;
    }

    .hidden {
      display: none;
    }

    legend {
      font-weight: bold;
      font-size: 17px;
      margin-bottom: 10px;
      color: #1e3a5f;
    }

    fieldset {
      border: 1px solid #aac8df;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #f9fbfd;
    }

    .question {
      margin-bottom: 12px;
    }

    .question label {
      margin-left: 15px;
    }

    input[type="radio"] {
      margin-left: 5px;
    }

    input[type="file"] {
      padding: 8px;
      border: 1px solid #aaa;
      border-radius: 5px;
      background-color: #ffffff;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
    }

    #previewImage {
      display: none;
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 22px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      display: block;
      margin: 20px auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    button:hover {
      background-color: #218838;
    }

    .result {
      margin-top: 25px;
      padding: 16px;
      border-radius: 8px;
      background: #e6f2ff;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      border: 1px solid #b3d1f0;
      white-space: pre-line;
    }
  </style>
</head>
<body>

<h1>בודק מהימנות לידיעה - שיטת RACE</h1>

<label for="imageUpload"><strong>העלה תמונה של הידיעה שברצונך לבדוק:</strong></label>
<input type="file" id="imageUpload" accept="image/*">
<img id="previewImage" src="" alt="תצוגה מקדימה של הידיעה">

<div style="text-align: right;">
  <button id="toggleBtn" onclick="toggleExplanation()">מה זה שיטת RACE?</button>
</div>

<div id="explanation" class="hidden">
  <p><strong>RACE</strong> היא שיטה לזיהוי וניתוח אמינות של תוכן חדשותי חשוד:</p>
  <ul>
    <li><strong>Recognize</strong> – זיהוי סימנים מחשידים בתוכן.</li>
    <li><strong>Analyze</strong> – ניתוח המסר: עובדות או רגש?</li>
    <li><strong>Contextualize</strong> – בדיקת הקשר והשלמות.</li>
    <li><strong>Evaluate</strong> – הערכת מטרת הידיעה.</li>
  </ul>
</div>

<!-- טופס השאלון -->
<form id="raceForm">
  <!-- כל fieldset כרגיל... -->
  <!-- ... -->
  <button type="button" onclick="calculateAndSummarize()">חשב ציון וסכם</button>
  <button type="button" onclick="downloadAsImage()">הורד כתמונה (JPG)</button>
</form>

<div class="result" id="result"></div>
<div class="result" id="summaryResult"></div>

<canvas id="summaryCanvas" style="display:none;"></canvas>

<script>
function toggleExplanation() {
  const explanation = document.getElementById("explanation");
  const toggleBtn = document.getElementById("toggleBtn");
  explanation.classList.toggle("hidden");
  toggleBtn.classList.toggle("open");
}

document.getElementById("imageUpload").addEventListener("change", function(event) {
  const file = event.target.files[0];
  const preview = document.getElementById("previewImage");
  if (file && file.type.startsWith("image/")) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = "block";
    };
    reader.readAsDataURL(file);
  } else {
    preview.src = "";
    preview.style.display = "none";
  }
});

function calculateAndSummarize() {
  // החישוב הרגיל של ציון + הסיכום המילולי
  // ... [כפי שהוגדר קודם, כולל summaryResult]
}

function downloadAsImage() {
  const canvas = document.getElementById("summaryCanvas");
  const ctx = canvas.getContext("2d");
  const imageInput = document.getElementById("imageUpload");
  const positives = document.getElementById('summaryResult').innerText.match(/\u2705.*?\n([\s\S]*?)(\n\u26A0|$)/);
  const negatives = document.getElementById('summaryResult').innerText.match(/\u26A0.*?\n([\s\S]*)/);
  const posLines = positives ? positives[1].trim().split("\n") : [];
  const negLines = negatives ? negatives[1].trim().split("\n") : [];
  const title = "סיכום הידיעה - על פי שיטת RACE";
  const padding = 20;
  const lineHeight = 30;
  const image = new Image();
  const reader = new FileReader();
  const file = imageInput.files[0];
  if (!file) {
    alert("לא נבחרה תמונה.");
    return;
  }
  reader.onload = function(e) {
    image.onload = function() {
      const textLines = posLines.length + negLines.length;
      const textHeight = (textLines + 5) * lineHeight;
      const imageHeight = image.height * Math.min(700 / image.width, 1);
      const canvasHeight = padding * 3 + textHeight + imageHeight;
      const canvasWidth = 800;
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#003366";
      ctx.font = "bold 24px Arial";
      ctx.fillText(title, padding, padding + 10);
      let y = padding + 50;
      ctx.font = "18px Arial";
      if (posLines.length) {
        ctx.fillStyle = "green";
        ctx.fillText("✅ נקודות המחזקות מהימנות:", padding, y);
        y += lineHeight;
        posLines.forEach(line => {
          ctx.fillText("- " + line.replace("- ", ""), padding + 10, y);
          y += lineHeight;
        });
      }
      if (negLines.length) {
        ctx.fillStyle = "#cc6600";
        y += 10;
        ctx.fillText("⚠️ נקודות שמחלישות מהימנות:", padding, y);
        y += lineHeight;
        negLines.forEach(line => {
          ctx.fillText("- " + line.replace("- ", ""), padding + 10, y);
          y += lineHeight;
        });
      }
      y += 10;
      const imageWidth = Math.min(700, image.width);
      const ratio = imageWidth / image.width;
      ctx.drawImage(image, padding, y, image.width * ratio, image.height * ratio);
      const link = document.createElement('a');
      link.download = "race_summary.jpg";
      link.href = canvas.toDataURL("image/jpeg");
      link.click();
    };
    image.src = e.target.result;
  };
  reader.readAsDataURL(file);
}
</script>

</body>
</html>
